<meta charset="utf8">
<html><body>
    <style type="text/css">
    .center{
        margin: 10px auto;
        text-align: center;
    }
    #li {
        list-style-type:none; color:#000000;
    }
    .display{
        text-align: left;
        width: 400px;
        margin: 10px auto;
    }
    </style>
    <div class="center">
        <div class="title">KeePwd<span style="font-size:xx-small">(同小程序KeePwd,单击复制或删除)</span></div>
        <div class="oper">
            <input type="text" placeholder="应用名" id="app" />
            <input type="text" placeholder="密码" id="pass" />
            <input type="button" onclick="add()" value="增加" />
            <input type="button" onclick="randpwd()" value="随机密码" />
        </div>
        <div class="display" id="display"></div>
    </div>
    <script>
        function updateView(){
            let passall = getStorage();
            let out = "";
            let tp = "<li id={id} value=“{value}” onclick=del({id})>{con}</li>";
            for(let i=0;i<passall.length;i++){
                out += tp.replace('{con}', passall[i].app+": "+passall[i].pass).replace("{id}", i).replace("{id}", i).replace('{value}', passall[i].pass);
            }
            document.all.display.innerHTML = out;
            document.all.pass.value = '';
            document.all.app.value = '';
        }
        updateView();

        function randpwd(){
            document.all.pass.value = randpass();
        }
        function randpass(le){
            let len = le || 10;
            let chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678'; // 默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1
            let maxPos = chars.length;
            let pwd = '';
            for (i = 0; i < len; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * maxPos));
            }
            return pwd;
        }

        function del(id){
            let passall = getStorage();
            let r = confirm("‘确定’进行复制；‘取消’进行删除" + JSON.stringify(passall[id]));
            if(r){
                document.all.pass.value = passall[id].pass;
                const input = document.querySelector('#pass');
                input.select();
                try{
                    console.log('复制 ' + document.execCommand('copy'));
                }catch(E){}
            }else{
                passall.splice(id, 1)
                writeStorage(passall);
                updateView();
            }
        }

        function getStorage(){
            let passall = [];
            if(localStorage.passall){
                passall = JSON.parse(localStorage.passall);
            }
            return passall;
        }

        function writeStorage(s){
            localStorage.passall = JSON.stringify(s);
        }

        function add(){
            let app = document.all.app.value;
            let pass = document.all.pass.value;
            if(!app || !pass){
                alert('不能为空');return;
            }
            let item = {};
            item.app = app;
            item.pass = pass;
            console.log("add "+ JSON.stringify(item));
            let passall = getStorage();
            passall.splice(0, 0, item);
            writeStorage(passall);
            updateView();
        }
    </script>
</body></html>
